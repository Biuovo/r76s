name: Build r76s OpenWrt (keep sbwml optimizations; only nikki + docker)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 720
    env:
      OPENWRT_REPO: https://github.com/openwrt/openwrt.git
      SBWML_BUILDER_REPO: https://github.com/sbwml/builder.git
      CONFIG_PATH: files/.config       # 你放 .config 的路径（请确保存在）
      SANITIZER: sanitize-config.sh   # 我随后给出的脚本名

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk flex git gettext libssl-dev xsltproc wget unzip python3 python3-distutils zlib1g-dev file subversion -y

      - name: Setup swap (optional, helps avoid OOM)
        run: |
          sudo fallocate -l 8G /swapfile || true
          sudo chmod 600 /swapfile || true
          sudo mkswap /swapfile || true
          sudo swapon /swapfile || true

      - name: Clone sbwml builder (to reuse optimizations/patches)
        run: |
          git clone --depth 1 $SBWML_BUILDER_REPO sbwml_builder || true
          # (可选) 如果你希望把 sbwml 的 feeds/patch 覆盖到 openwrt，请在本步骤后面添加复制命令。

      - name: Clone OpenWrt source
        run: |
          git clone --depth 1 $OPENWRT_REPO openwrt

      - name: Copy .config and files/ into openwrt
        run: |
          if [ -f "${{ env.CONFIG_PATH }}" ]; then
            cp "${{ env.CONFIG_PATH }}" openwrt/.config
          else
            echo "ERROR: ${CONFIG_PATH} not found. Please add files/.config to repo." && exit 1
          fi
          if [ -d "files" ]; then
            cp -r files openwrt/
          fi

      - name: Add Nikki feed entry (so nikki package is available)
        working-directory: openwrt
        run: |
          echo "src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki.git;main" >> feeds.conf.default
          cat feeds.conf.default

      - name: Copy sanitizer script and run it (keep target/profile + enable nikki & docker)
        run: |
          cp ${{ github.workspace }}/${{ env.SANITIZER }} openwrt/${{ env.SANITIZER }} || true
          chmod +x openwrt/${{ env.SANITIZER }}
          pushd openwrt
          ./${{ env.SANITIZER }}
          popd

      - name: Update & install feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Defconfig (sync .config)
        working-directory: openwrt
        run: |
          make defconfig

      - name: Build OpenWrt
        working-directory: openwrt
        run: |
          make -j$(nproc) V=s 2>&1 | tee build.log

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: openwrt/build.log

      - name: Upload firmware artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-artifacts
          path: openwrt/bin/targets/**

      - name: Cleanup swap
        if: runner.os == 'Linux'
        run: |
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile || true
