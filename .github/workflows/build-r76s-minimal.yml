name: Build r76s OpenWrt (nikki + docker + frpc + tailscale)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 720
    env:
      OPENWRT_REPO: https://github.com/openwrt/openwrt.git
      SBWML_BUILDER_REPO: https://github.com/sbwml/builder.git
      CONFIG_PATH: files/.config
      MAKE_JOBS: 2   # 推荐 -j2 稳定性更好；如你希望更快可改为 $(nproc)
      SANITIZER_NAME: sanitize-config.sh

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps (including pyelftools)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses5-dev gawk flex git gettext \
            libssl-dev xsltproc wget unzip python3 python3-distutils \
            python3-setuptools python3-pyelftools \
            zlib1g-dev file subversion swig ca-certificates -y

      - name: Setup swap (helps avoid OOM)
        run: |
          sudo fallocate -l 8G /swapfile || true
          sudo chmod 600 /swapfile || true
          sudo mkswap /swapfile || true
          sudo swapon /swapfile || true
          echo "Swap enabled."

      - name: Clone sbwml builder (optional opt/patch source)
        run: |
          git clone --depth 1 $SBWML_BUILDER_REPO sbwml_builder || true
          echo "sbwml builder cloned."

      - name: Clone OpenWrt source
        run: |
          git clone --depth 1 $OPENWRT_REPO openwrt

      - name: Copy .config and files/ into openwrt
        run: |
          if [ -f "${{ env.CONFIG_PATH }}" ]; then
            cp "${{ env.CONFIG_PATH }}" openwrt/.config
            echo "Copied ${CONFIG_PATH} -> openwrt/.config"
          else
            echo "ERROR: ${CONFIG_PATH} not found. Please add files/.config to repo." && exit 1
          fi
          if [ -d "files" ]; then
            cp -r files openwrt/ || true
          fi

      - name: Add feeds: nikki, frp, luci-frpc, tailscale
        working-directory: openwrt
        run: |
          echo "src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki.git;main" >> feeds.conf.default
          echo "src-git frp https://github.com/kuoruan/openwrt-frp.git;main" >> feeds.conf.default
          echo "src-git luci-frpc https://github.com/kuoruan/luci-app-frpc.git;main" >> feeds.conf.default
          echo "src-git tailscale https://github.com/lanrat/openwrt-tailscale-repo.git;main" >> feeds.conf.default
          echo "Final feeds.conf.default:"
          cat feeds.conf.default

      - name: Write sanitizer script into openwrt and make it executable
        run: |
          cat > openwrt/${{ env.SANITIZER_NAME }} <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
CFG=".config"
BACKUP=".config.orig"
KEEP_PATTERNS=(
  "^CONFIG_TARGET_"
  "^CONFIG_TARGET_DEVICE_"
  "^CONFIG_TARGET_.*_DEVICE_"
  "^CONFIG_TARGET_ROOTFS"
  "^CONFIG_KERNEL_"
  "^CONFIG_KMOD_"
  "^CONFIG_USB_"
  "^CONFIG_PACKAGE_kmod"
  "^CONFIG_NETFILTER_"
  "^CONFIG_BRIDGE_"
  "^CONFIG_NF_"
  "^CONFIG_SOMAXCONN"
  "^CONFIG_PACKAGE_base-files"
  "^CONFIG_BUILD_"
  "^CONFIG_VERSION"
)

REQUIRED_PACKAGES=(
  "CONFIG_PACKAGE_nikki=y"
  "CONFIG_PACKAGE_luci-app-nikki=y"
  "CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y"
  "CONFIG_PACKAGE_frp=y"
  "CONFIG_PACKAGE_luci-app-frpc=y"
)

DOCKER_PACKAGES=(
  "CONFIG_PACKAGE_docker=y"
  "CONFIG_PACKAGE_dockerd=y"
  "CONFIG_PACKAGE_docker-compose=y"
)

TAILSCALE_PACKAGES=(
  "CONFIG_PACKAGE_tailscale=y"
  "CONFIG_PACKAGE_tailscaled=y"
)

if [ -f "$CFG" ]; then
  cp -a "$CFG" "$BACKUP"
else
  echo "No ${CFG} found in $(pwd) — aborting" >&2
  exit 1
fi

TMPCFG="${CFG}.tmp"
: > "$TMPCFG"

while IFS= read -r line; do
  keep=false
  for pat in "${KEEP_PATTERNS[@]}"; do
    if echo "$line" | grep -qiE "$pat"; then
      keep=true
      break
    fi
  done
  if $keep; then
    echo "$line" >> "$TMPCFG"
  fi
done < "$BACKUP"

grep -E '^CONFIG_BUILD|^CONFIG_TARGET' "$BACKUP" >> "$TMPCFG" || true

echo "" >> "$TMPCFG"
echo "# --- sanitized: keep nikki + docker + frpc + tailscale packages ---" >> "$TMPCFG"

for p in "${REQUIRED_PACKAGES[@]}"; do
  grep -qF "$p" "$TMPCFG" || echo "$p" >> "$TMPCFG"
done

for p in "${DOCKER_PACKAGES[@]}"; do
  grep -qF "$p" "$TMPCFG" || echo "$p" >> "$TMPCFG"
done

for p in "${TAILSCALE_PACKAGES[@]}"; do
  grep -qF "$p" "$TMPCFG" || echo "$p" >> "$TMPCFG"
done

grep -qE '^CONFIG_BUILD_MANIFEST' "$TMPCFG" || echo "CONFIG_BUILD_MANIFEST=y" >> "$TMPCFG"

mv "$TMPCFG" "$CFG"

echo "Sanitization done. Backed up original to $BACKUP"
echo "New .config head:"
head -n 200 "$CFG" || true
EOF
          chmod +x openwrt/${{ env.SANITIZER_NAME }}
          echo "Sanitizer written to openwrt/${{ env.SANITIZER_NAME }}"

      - name: (Optional) Copy sbwml customizations into openwrt if exists
        run: |
          # 如果想强制使用 sbwml 的 feeds/patch 等，把它们从 sbwml_builder 复制进 openwrt
          if [ -d sbwml_builder/openwrt_custom ]; then
            cp -r sbwml_builder/openwrt_custom/* openwrt/ || true
            echo "Copied sbwml custom files to openwrt/"
          else
            echo "No sbwml openwrt_custom found; skipping."
          fi

      - name: Run sanitizer (inside openwrt)
        working-directory: openwrt
        run: |
          echo "Running sanitizer to trim .config and force-enable packages..."
          ./${{ env.SANITIZER_NAME }}

      - name: Update & install feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Defconfig (sync .config)
        working-directory: openwrt
        run: |
          make defconfig

      - name: Build OpenWrt (make)
        working-directory: openwrt
        # 使用较低并行数以降低 OOM/被 killed 的概率；如你有更大 runner 可改为 -j$(nproc)
        run: |
          make -j${{ env.MAKE_JOBS }} V=s 2>&1 | tee build.log
        timeout-minutes: 600

      - name: List openwrt/bin contents for debug
        working-directory: openwrt
        run: |
          echo "==== ls -la openwrt/bin ===="
          ls -la bin || true
          echo "==== find openwrt/bin depth=5 (files) ===="
          find bin -maxdepth 6 -type f -print || true
          echo "==== full tree (top 4 levels) ===="
          find . -maxdepth 4 -print || true
          find bin -maxdepth 6 -type f -print > build-bin-listing.txt || true

      - name: Upload build listing & build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-listing-and-log
          path: |
            openwrt/build.log
            openwrt/build-bin-listing.txt

      - name: Upload firmware artifacts (broad patterns)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-artifacts
          path: |
            openwrt/bin/**
            openwrt/bin/targets/**

      - name: Cleanup swap
        if: runner.os == 'Linux'
        run: |
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile || true
