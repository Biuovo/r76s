name: Build r76s OpenWrt (nikki + docker + frpc + tailscale)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 720
    env:
      OPENWRT_REPO: https://github.com/openwrt/openwrt.git
      CONFIG_PATH: files/.config
      MAKE_JOBS: 2
      SANITIZER_NAME: sanitize-config.sh

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk flex git gettext libssl-dev xsltproc wget unzip \
            python3 python3-distutils python3-setuptools python3-pyelftools \
            zlib1g-dev file subversion swig ca-certificates

      - name: Setup swap
        run: |
          sudo fallocate -l 8G /swapfile || true
          sudo chmod 600 /swapfile || true
          sudo mkswap /swapfile || true
          sudo swapon /swapfile || true

      - name: Clone OpenWrt
        run: git clone --depth 1 $OPENWRT_REPO openwrt

      - name: Copy .config
        run: |
          if [ ! -f "${{ env.CONFIG_PATH }}" ]; then
            echo "ERROR: files/.config 不存在！你必须提供设备的 .config 文件"
            exit 1
          fi
          cp "${{ env.CONFIG_PATH }}" openwrt/.config

      - name: Add custom feeds (nikki frp tailscale)
        working-directory: openwrt
        run: |
          echo "src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki.git;main" >> feeds.conf.default
          echo "src-git frp https://github.com/kuoruan/openwrt-frp.git;main" >> feeds.conf.default
          echo "src-git luci-frpc https://github.com/kuoruan/luci-app-frpc.git;main" >> feeds.conf.default
          echo "src-git tailscale https://github.com/lanrat/openwrt-tailscale-repo.git;main" >> feeds.conf.default

      - name: Write sanitizer script
        working-directory: openwrt
        run: |
          cat > ${{ env.SANITIZER_NAME }} << 'EOF'
IyEvdXNyL2Jpbi9lbnYgYmFzaApzZXQgLWV1byBwaXBlZmFpbApDRkc9Ii5jb25maWciCkJBQ0tVUD0i
LmNvbmZpZy5vcmlnIgpLRUVQX1BBVEVSTlM9KApJQ09ORklHX1RBUkdFTF8KIklDT05GSUdfVEFSR0VU
X0RFVklDRV8iCiJcVkVSU0lPTiIKKQpSRVFVSVJFRF9QQUNLQUdFUz0oCiAgIkNPTkZJR19QQUNLQUdF
X25pa2tpPXkiCiAgIkNPTkZJR19QQUNLQUdFX2x1Y2ktYXBwLW5pa2tpPXkiCiAgIkNPTkZJR19QQUNL
QUdFX2x1Y2ktaTE4bi1uaWtraS16aC1jbj15IgogICJDT05G SUdfUEFDS0FHRV9mcnA9eSIKICAiQ09O
RklHX1BBQ0tBR0VfbHVjaS1hcHAtZnJwYz15IgopCkRPQ0tFUl9QQUNLQUdFUz0oCiAgIkNPTkZJR19Q
QUNLQUdFX2RvY2tlcj15IgogICJDT05G SUdfUEFDS0FHRV9kb2NrZXJkPXkiCiAgIkNPTkZJR19QQUNL
QUdFX2RvY2tlci1jb21wb3NlPXkiCikKVEFJTFNDQUxFX1BBQ0tBR0VTPQoKSUYoWyAtZiAiJENGRyIg
XTspOyB0aGVuCiAgY3AgLS1wcmVzZXJ2ZSAiJENGRyIgIiRCQUNLVVAiCmZpCgpUTVBDRkc9IiRDRkcu
dG1wIgpiYXNoIC1jICJjYXQgPC9kZXZfdnVsbCBub3RMIGZpsCI+ICRU TVBDRkcKCmhlYWQgLWxhIDIw
MCAkVEN GRyB8fCB0cnVlCk1WICRU TVBDRmcgIiRDRkciCgo=
EOF

          base64 -d ${{ env.SANITIZER_NAME }} > tmp.sh
          mv tmp.sh ${{ env.SANITIZER_NAME }}
          chmod +x ${{ env.SANITIZER_NAME }}

      - name: Run sanitizer
        working-directory: openwrt
        run: ./${{ env.SANITIZER_NAME }}

      - name: Update & Install feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: make defconfig
        working-directory: openwrt
        run: make defconfig

      - name: Build firmware
        working-directory: openwrt
        run: make -j${{ env.MAKE_JOBS }} V=s 2>&1 | tee build.log

      - name: List build output
        working-directory: openwrt
        run: |
          echo "--- openwrt/bin ---"
          find bin -type f || true
          cp build.log ../build.log

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: openwrt/bin/**
