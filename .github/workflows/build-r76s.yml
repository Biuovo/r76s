name: Build r76s OpenWrt (minimal, nikki+docker+frpc+tailscale)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 720
    env:
      OPENWRT_REPO: https://github.com/openwrt/openwrt.git
      CONFIG_PATH: files/.config
      MAKE_JOBS: 2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses5-dev gawk flex git gettext \
            libssl-dev xsltproc wget unzip python3 python3-distutils \
            python3-setuptools python3-pyelftools zlib1g-dev file \
            subversion swig ca-certificates

      - name: Setup swap (optional)
        run: |
          sudo fallocate -l 8G /swapfile || true
          sudo chmod 600 /swapfile || true
          sudo mkswap /swapfile || true
          sudo swapon /swapfile || true
          echo "swap enabled"

      - name: Clone OpenWrt
        run: |
          git clone --depth 1 $OPENWRT_REPO openwrt

      - name: Copy files/.config to openwrt
        run: |
          if [ ! -f "${{ env.CONFIG_PATH }}" ]; then
            echo "ERROR: ${CONFIG_PATH} not found. Please add files/.config"
            exit 1
          fi
          cp "${{ env.CONFIG_PATH }}" openwrt/.config
          echo "Copied ${CONFIG_PATH} -> openwrt/.config"

      - name: Add custom feeds (nikki / frp / luci-frpc / tailscale)
        working-directory: openwrt
        run: |
          echo 'src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki.git;main' >> feeds.conf.default
          echo 'src-git frp https://github.com/kuoruan/openwrt-frp.git;main' >> feeds.conf.default
          echo 'src-git luci-frpc https://github.com/kuoruan/luci-app-frpc.git;main' >> feeds.conf.default
          echo 'src-git tailscale https://github.com/lanrat/openwrt-tailscale-repo.git;main' >> feeds.conf.default
          echo "feeds.conf.default content:"
          cat feeds.conf.default

      - name: Update and install feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: make defconfig
        working-directory: openwrt
        run: make defconfig

      - name: Build OpenWrt (make)
        working-directory: openwrt
        run: |
          make -j${{ env.MAKE_JOBS }} V=s 2>&1 | tee build.log

      - name: List build outputs and save listing
        working-directory: openwrt
        run: |
          echo "---- find bin ----"
          find bin -type f -maxdepth 6 -print || true
          find . -maxdepth 3 -print || true
          find bin -type f -maxdepth 6 -print > build-bin-listing.txt || true
          cp build.log ../build.log || true

      - name: Upload build log and listing
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-log
          path: |
            openwrt/build.log
            openwrt/build-bin-listing.txt
            build.log

      - name: Upload firmware artifacts (if any)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: openwrt/bin/**
